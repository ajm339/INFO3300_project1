<!DOCTYPE html>
<html>
	<head>
		<title>Project 1</title>

		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script src="http://fb.me/react-0.9.0.min.js"></script>
		<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
        <script src="testData.js"></script>
        <script src="posts1000.js"></script>


		<style>
			svg { border: solid black 1px; }
			.axis path { fill: none; stroke: black;}
			.axis line { stroke: black; }
			text.trending_words { font-size: small; font-family: "Helvetica"; text-anchor: middle; alignment-baseline: central; cursor: pointer;}
			text.trending_words:hover {font-weight: bold; font-size: xx-large; }
            text.trending_words.opacity{opacity: '1.0'};
		</style>
	</head>



	<body>
		<h1>Project 1</h1>
		<div id='spot'></div>
		<div id='canvas'></div>


		<script>
        function opacityScale(y){
            if(y==0){
                return 0.3;
            } else {
                return (y/15);
            }
        }
        function mouseover(){
            d3.select(this).style("opacity", "1.0");
        }
        function mouseout(){
            d3.select(this).style("opacity", function(w){return opacityScale(Math.abs(w.y))});
        }

        var xScale = d3.scale.linear().domain([0, 20]).range([150,880]);
		var yScale = d3.scale.linear().domain([-20,20]).range([750,20]);
		
		var svg = d3.select("#canvas").append("svg").attr("height", 800).attr("width", 1050);

        var number_of_points = 1000;
        var input = [];


        for(var i = 1; i <= number_of_points; i++){
            input.push({"word": "banana" + i, "x": getRandomInt(0,20), "y": getRandomInt(-20, 20)});
        }

        /**
         * Returns a random integer between min and max
         * Using Math.round() will give you a non-uniform distribution!
         */
        function getRandomInt (min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

		/*var input = [
			{"word": "of", "x": 1, "y": 5},
			{"word": "the", "x": 4, "y": -4},
<<<<<<< HEAD
			{"word": "banana", "x": 8, "y": 0}  ];*/
=======
			{"word": "banana", "x": 8, "y": 0},
            {"word": "mateo", "x": 18, "y": 20},
            {"word": "yum", "x": 10, "y": -10},
            {"word": "hello", "x": 7, "y": 8},
            {"word": "mateo", "x": 12, "y": -14}  ];
>>>>>>> d86b4c8d26497f3bc39776fe6f664b06696e0b41

  			var words = svg.selectAll("text").data(input).enter().append("text");
  			var wordAttributes = words
  				.attr("class", "trending_words")
  				.attr("x", function(w) {return xScale(w.x);})
  				.attr("y", function(w) {return yScale(w.y);})
                .style("fill", function(w){ if(w.y>0){return "#006633"}else if(w.y<0){return "8B1A1A"}else{return "000000"}})
  				.text(function (w) { return w.word; })
                .style("opacity", function(w){return opacityScale(Math.abs(w.y))});

            d3.selectAll("text").on('mouseover', mouseover).on('mouseout', mouseout);

            
            
            

  		svg.append("text").attr("x", xScale(-3)).attr("y", yScale(-0.5)).text("Time Blocks");
  		svg.append("text").attr("x", xScale(-11)).attr("y", yScale(16)).text("Trending Status").attr("transform", "rotate(-90)");
  		svg.append("text").attr("x", xScale(-12)).attr("y", yScale(15)).text("(is popularity increasing or decreasing over time)").attr("transform", "rotate(-90)").attr("font-size", "8pt");
  		

		var xAxis = d3.svg.axis().scale(xScale);

		svg.append("g").attr("class", "axis").attr("transform", "translate(0, " + yScale(0) + ")").call(xAxis);

		var yAxis = d3.svg.axis().scale(yScale).orient("left");
		svg.append("g").attr("class", "axis").attr("transform", "translate(" + xScale(0) + ", 0)").call(yAxis);


        var getter = {
            reqSize : 25,
            acc : [],
            baseURL : "http://www.reddit.com/new/.json?&limit=25",
            nextURL : null,
            apiCount : 0,
            prevData: null,


            nextPageURL: function(data){
                this.apiCount+=25;
                this.nextURL = (this.baseURL+"&count="+this.apiCount+"&after="+data.data.after);
            },

            requestAPage : function(){
                if (this.nextURL==null){
                    var url = this.baseURL;
                }else{
                    var url = this.nextURL;
                }
                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function(data) {
                        //console.log(data);
                        //console.log("acc length="+this.acc.length);
                        //console.log(this.nextURL);

                        console.log("Querried: "+url);
                        console.log("nextURL:  "+this.nextURL);
                        console.log(data.data.after);
                        this.prevData = data;
                        this.acc = this.acc.concat(data.data.children);
                        this.nextPageURL(data);
                        console.log("NEW nextURL:  "+this.nextURL);

                        //console.log(data);
                        //console.log("acc length="+this.acc.length);
                        //console.log(this.nextURL);

                    }.bind(this)
                });
            },

            returnUniques : function(){
                var unqs = [];
                var i;
                for (i= 0; i < this.acc.length ; i++){
                    if(unqs.indexOf(this.acc[i]) == -1){
                        unqs = unqs.concat(this.acc[i]);
                    }
                }
                //console.log(this.acc.length);
                //console.log(unqs.length);
            },

            getData : function(){
                var getNPagesCt = 0;
                var get10pages = setInterval(function(){
                    getter.requestAPage();
                    getNPagesCt ++;
                    if (getNPagesCt >= 10){
                        clearInterval(get10pages);
                    }
                    console.log(getter.acc.length);
                    },2000);
            }

        }//end getter

        returnUniques = function(arg){
            var unqs = [];
            var i;
            for (i= 0; i < arg.length ; i++){
                if(unqs.indexOf(arg[i]) == -1){
                    unqs = unqs.concat(arg[i]);
                }
            }
            //console.log(arg.length);
            //console.log(unqs.length);
            //return unqs.sort(function(a,b){return a-b});
            return unqs;
        }

        function timeBins(posts, binWidthInSecs){
            var times = [];
            posts.forEach(function(p){
                /*console.log(p.data.created_utc);*/
                times = times.concat(p.data.created_utc);
            });
            var start = Math.min.apply(Math, times);
            var end = Math.max.apply(Math, times);

            var relTimes = [];
            times.forEach(function(t){relTimes = relTimes.concat(t-start);});

            var bins = [];
            posts.forEach(function(p){
                var t = Math.floor((p.data.created_utc - start)/(binWidthInSecs));
                if (typeof(bins[t])=="undefined"){
                    bins[t] =[];
                    bins[t] = bins[t].concat(p);
                }else{
                    bins[t] = bins[t].concat(p);
                }
            });//end forEach

            for(var i = 0; i<bins.length;i++){
                if(typeof(bins[i]) == "undefined"){bins[i]=[]}
            }

            return [bins,times,relTimes];

        }


        function isSorted(posts){
            var isSorted = true;
            var sorted = [];
            var BreakException =  {};
            function isBigger(sorted, cur){
                var isit = true;
                try{
                    sorted.forEach(function(x){
                        if(x==undefined){
                            null;
                        }else if(x.data.created_utc>cur.data.created_utc){
                            isit = false;
                            throw BreakException;
                        }
                    })
                }catch(e){
                    if(e==BreakException){
                        return isit;
                    }
                }//end try-catch
                return isit;
            }

            posts.forEach(function(p){
                if(isBigger(sorted,p)){
                    sorted.push(p);
                }else{
                    isSorted = false
                    return isSorted;
                }
            })
            return isSorted;
        }

        function arrayCompare(anArray, accessorFunc, compareFunc){
            var max;
            anArray.forEach(function(el){
                if(max==undefined){
                    max=el;
                }else if(compareFunc(accessorFunc(max),accessorFunc(el))){
                    max =el;
                }
            });
            return max;
        }


        function extractTitleWords(posts){

            var words = [];
            posts.forEach(function(p){
                words = words.concat(p.data.title.replace(/[^\w\s]|_/g, "") //Strips punc
                             .toLocaleLowerCase().split(" ")); //makes it lowercase and splits
            });

            wordCounter = {};
            words.forEach(function(w){
               if(typeof(wordCounter[w.toLocaleLowerCase()])=="number"){
                   wordCounter[w.toLocaleLowerCase()]+=1;
               }else{
                   wordCounter[w.toLocaleLowerCase()]=1;
               }
            });

            //ToDo RETURN WORDS SORTED BY FREQUENCY

            return wordCounter;
        }//end extract title words

        function wordCountsAtIntervals(timeWindowIntervalSecs, posts){
            var tWin = timeWindowIntervalSecs;
            var posts = returnUniques(posts);
            var postData = timeBins(posts,tWin);
            var wordsAtTimes = [];
            postData[0].forEach(
               function(bin){
                   wordsAtTimes.push(extractTitleWords(bin));
               }
            );
            return wordsAtTimes;
        }

        function mapWords(wordsAtTimes){
            avgWordFreq = {};
            var allWords = [];
            wordsAtTimes.forEach(function(t){
                    allWords = allWords.concat(Object.keys(t));
            });

            allWords = returnUniques(allWords);

            allWords.forEach(function(w){avgWordFreq[w] = 0;})

            wordsAtTimes.forEach(function(t){

                        var ks = Object.keys(t);
                        ks.forEach(function(k){avgWordFreq[k]+=t[k]})

                    }
            );

        }



		</script>
	</body>
</html>